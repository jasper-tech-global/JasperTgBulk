{% extends "layout.html" %}

{% block title %}SMTP Profiles - Jasper TG BULK{% endblock %}

{% block content %}
<div class="min-h-screen" style="background: var(--bg-primary);">
    <!-- Header Section -->
    <div class="bg-white shadow-sm border-b" style="border-color: var(--border-color);">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-6">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 rounded-lg flex items-center justify-center" style="background: var(--blue-600-bg);">
                        <i class="fas fa-envelope text-xl" style="color: var(--blue-600-text);"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold" style="color: var(--text-primary);">SMTP Profiles</h1>
                        <p class="text-sm" style="color: var(--text-secondary);">Configure and manage your email server connections</p>
                    </div>
                </div>
                <button onclick="openAddModal()" class="btn-primary-enhanced px-6 py-3 rounded-lg flex items-center space-x-2">
                    <i class="fas fa-plus"></i>
                    <span>Add New Profile</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {% if rows %}
        <!-- SMTP Profiles Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for profile in rows %}
            <div class="bg-white rounded-xl shadow-sm border-2 transition-all duration-300 hover:shadow-lg" style="border-color: var(--border-color);">
                <!-- Profile Header -->
                <div class="p-6 border-b" style="border-color: var(--border-color);">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 rounded-lg flex items-center justify-center" style="background: var(--green-600-bg);">
                                <i class="fas fa-server text-lg" style="color: var(--green-600-text);"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold text-lg" style="color: var(--text-primary);">{{ profile.name }}</h3>
                                <p class="text-sm" style="color: var(--text-secondary);">{{ profile.host }}:{{ profile.port }}</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            {% if profile.active %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium" style="background: var(--status-active-bg); color: var(--status-active-text);">
                                <i class="fas fa-check-circle mr-1"></i>Active
                            </span>
                            {% else %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium" style="background: var(--status-inactive-bg); color: var(--status-inactive-text);">
                                <i class="fas fa-pause-circle mr-1"></i>Inactive
                            </span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Profile Details -->
                    <div class="space-y-2">
                        <div class="flex items-center space-x-2 text-sm">
                            <i class="fas fa-user" style="color: var(--text-secondary);"></i>
                            <span style="color: var(--text-primary);">{{ profile.username }}</span>
                        </div>
                        <div class="flex items-center space-x-2 text-sm">
                            <i class="fas fa-envelope" style="color: var(--text-secondary);"></i>
                            <span style="color: var(--text-primary);">{{ profile.from_email }}</span>
                        </div>
                        {% if profile.from_name %}
                        <div class="flex items-center space-x-2 text-sm">
                            <i class="fas fa-building" style="color: var(--text-secondary);"></i>
                            <span style="color: var(--text-primary);">{{ profile.from_name }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Security Info -->
                <div class="px-6 py-4 border-b" style="border-color: var(--border-color);">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            {% if profile.use_tls %}
                            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium" style="background: var(--green-100-bg); color: var(--green-600-text);">
                                <i class="fas fa-lock mr-1"></i>TLS
                            </span>
                            {% endif %}
                            {% if profile.use_starttls %}
                            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium" style="background: var(--blue-100-bg); color: var(--blue-600-text);">
                                <i class="fas fa-shield-alt mr-1"></i>STARTTLS
                            </span>
                            {% endif %}
                        </div>
                        <span class="text-xs" style="color: var(--text-secondary);">Created {{ profile.created_at.strftime('%b %d, %Y') }}</span>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="p-6">
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="testSMTP({{ profile.id }})" class="btn-success text-sm py-2 px-3 rounded-lg flex items-center justify-center space-x-2">
                            <i class="fas fa-paper-plane"></i>
                            <span>Test</span>
                        </button>
                        <button onclick="runDiagnostics({{ profile.id }})" class="btn-primary text-sm py-2 px-3 rounded-lg flex items-center justify-center space-x-2">
                            <i class="fas fa-stethoscope"></i>
                            <span>Diagnose</span>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3 mt-3">
                        <button onclick="toggleActive({{ profile.id }}, '{{ profile.active|lower }}')" class="btn-secondary text-sm py-2 px-3 rounded-lg flex items-center justify-center space-x-2">
                            <i class="fas fa-{% if profile.active %}pause{% else %}play{% endif %}"></i>
                            <span>{% if profile.active %}Deactivate{% else %}Activate{% endif %}</span>
                        </button>
                        <button onclick="editSMTP({{ profile.id }})" class="btn-warning text-sm py-2 px-3 rounded-lg flex items-center justify-center space-x-2">
                            <i class="fas fa-edit"></i>
                            <span>Edit</span>
                        </button>
                    </div>
                    
                    <button onclick="deleteSMTP({{ profile.id }})" class="w-full mt-3 btn-danger text-sm py-2 px-3 rounded-lg flex items-center justify-center space-x-2">
                        <i class="fas fa-trash"></i>
                        <span>Delete Profile</span>
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <!-- Empty State -->
        <div class="text-center py-16">
            <div class="w-24 h-24 mx-auto mb-6 rounded-full flex items-center justify-center" style="background: var(--gray-100-bg);">
                <i class="fas fa-envelope text-3xl" style="color: var(--text-secondary);"></i>
            </div>
            <h3 class="text-xl font-semibold mb-2" style="color: var(--text-primary);">No SMTP Profiles Yet</h3>
            <p class="text-sm mb-6" style="color: var(--text-secondary);">Get started by adding your first SMTP profile to send emails</p>
            <button onclick="openAddModal()" class="btn-primary-enhanced px-6 py-3 rounded-lg">
                <i class="fas fa-plus mr-2"></i>Add Your First Profile
            </button>
        </div>
        {% endif %}
    </div>
</div>

<!-- Add/Edit SMTP Profile Modal -->
<div id="smtp-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <!-- Modal Header -->
            <div class="p-6 border-b" style="border-color: var(--border-color);">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-lg flex items-center justify-center" style="background: var(--green-600-bg);">
                            <i class="fas fa-plus text-lg" style="color: var(--green-600-text);"></i>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold" style="color: var(--text-primary);" id="modal-title">Add New SMTP Profile</h2>
                            <p class="text-sm" style="color: var(--text-secondary);">Configure your email server connection</p>
                        </div>
                    </div>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>

            <!-- Modal Form -->
            <form id="smtp-form" method="POST" class="p-6 space-y-6">
                <input type="hidden" id="profile-id" name="profile_id">
                
                <!-- Basic Information -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <label class="form-label" style="color: var(--text-primary); font-weight: 600;">
                            <i class="fas fa-tag mr-2" style="color: var(--blue-600-text);"></i>Profile Name
                        </label>
                        <input type="text" name="name" id="profile-name" required class="form-input-enhanced" placeholder="e.g., Gmail, Outlook, Company SMTP">
                    </div>
                    
                    <div class="space-y-2">
                        <label class="form-label" style="color: var(--text-primary); font-weight: 600;">
                            <i class="fas fa-globe mr-2" style="color: var(--green-600-text);"></i>SMTP Host
                        </label>
                        <input type="text" name="host" id="profile-host" required class="form-input-enhanced" placeholder="e.g., smtp.gmail.com" onchange="showConfigurationGuide(this.value)">
                    </div>
                    
                    <div class="space-y-2">
                        <label class="form-label" style="color: var(--text-primary); font-weight: 600;">
                            <i class="fas fa-bolt mr-2" style="color: var(--purple-600-text);"></i>Port
                        </label>
                        <input type="number" name="port" id="profile-port" required class="form-input-enhanced" value="587" min="1" max="65535">
                    </div>
                    
                    <div class="space-y-2">
                        <label class="form-label" style="color: var(--text-primary); font-weight: 600;">
                            <i class="fas fa-user mr-2" style="color: var(--orange-600-text);"></i>Username
                        </label>
                        <input type="text" name="username" id="profile-username" required class="form-input-enhanced" placeholder="your-email@gmail.com">
                    </div>
                    
                    <div class="space-y-2">
                        <label class="form-label" style="color: var(--text-primary); font-weight: 600;">
                            <i class="fas fa-lock mr-2" style="color: var(--red-600-text);"></i>Password
                        </label>
                        <input type="password" name="password" id="profile-password" class="form-input-enhanced" placeholder="App password or regular password">
                        <p class="text-xs" style="color: var(--text-secondary);">Leave empty to keep existing password when editing</p>
                    </div>
                    
                    <div class="space-y-2">
                        <label class="form-label" style="color: var(--text-primary); font-weight: 600;">
                            <i class="fas fa-envelope mr-2" style="color: var(--pink-600-text);"></i>From Email
                        </label>
                        <input type="email" name="from_email" id="profile-from-email" required class="form-input-enhanced" placeholder="noreply@yourcompany.com">
                    </div>
                    
                    <div class="space-y-2">
                        <label class="form-label" style="color: var(--text-primary); font-weight: 600;">
                            <i class="fas fa-building mr-2" style="color: var(--blue-600-text);"></i>From Name
                        </label>
                        <input type="text" name="from_name" id="profile-from-name" class="form-input-enhanced" placeholder="Your Company Name">
                    </div>
                </div>

                <!-- Security Configuration -->
                <div class="p-6 rounded-xl border-2" style="background: var(--bg-secondary); border-color: var(--border-color);">
                    <h4 class="text-lg font-semibold mb-4 flex items-center" style="color: var(--text-primary);">
                        <i class="fas fa-shield-alt mr-2" style="color: var(--green-600-text);"></i>Security Configuration
                    </h4>
                    <div class="flex items-center space-x-8">
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="checkbox" name="use_tls" id="profile-use-tls" class="form-checkbox-enhanced">
                            <span class="text-sm font-medium" style="color: var(--text-primary);">Use TLS</span>
                        </label>
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="checkbox" name="use_starttls" id="profile-use-starttls" class="form-checkbox-enhanced" checked>
                            <span class="text-sm font-medium" style="color: var(--text-primary);">Use STARTTLS</span>
                        </label>
                    </div>
                    
                    <!-- SendGrid Configuration Guide -->
                    <div id="sendgrid-guide" class="mt-4 p-4 rounded-lg hidden" style="background: #eff6ff; border: 1px solid #93c5fd;">
                        <h5 class="font-semibold mb-2 text-sm" style="color: #1e40af;">
                            <i class="fas fa-info-circle mr-2"></i>SendGrid Configuration Guide
                        </h5>
                        <div class="text-xs space-y-1" style="color: #1d4ed8;">
                            <p><strong>Host:</strong> smtp.sendgrid.net</p>
                            <p><strong>Port:</strong> 587 (STARTTLS) or 465 (TLS)</p>
                            <p><strong>Username:</strong> apikey</p>
                            <p><strong>Password:</strong> Your SendGrid API Key</p>
                            <p><strong>Security:</strong> Enable STARTTLS for port 587, TLS for port 465</p>
                        </div>
                    </div>
                    
                    <!-- Gmail Configuration Guide -->
                    <div id="gmail-guide" class="mt-4 p-4 rounded-lg hidden" style="background: #f0fdf4; border: 1px solid #86efac;">
                        <h5 class="font-semibold mb-2 text-sm" style="color: #166534;">
                            <i class="fas fa-info-circle mr-2"></i>Gmail Configuration Guide
                        </h5>
                        <div class="text-xs space-y-1" style="color: #15803d;">
                            <p><strong>Host:</strong> smtp.gmail.com</p>
                            <p><strong>Port:</strong> 587 (STARTTLS) or 465 (TLS)</p>
                            <p><strong>Username:</strong> your-email@gmail.com</p>
                            <p><strong>Password:</strong> App Password (not regular password)</p>
                            <p><strong>Security:</strong> Enable STARTTLS for port 587, TLS for port 465</p>
                        </div>
                    </div>
                    
                    <!-- Outlook Configuration Guide -->
                    <div id="outlook-guide" class="mt-4 p-4 rounded-lg hidden" style="background: #faf5ff; border: 1px solid #c4b5fd;">
                        <h5 class="font-semibold mb-2 text-sm" style="color: #7c3aed;">
                            <i class="fas fa-info-circle mr-2"></i>Outlook Configuration Guide
                        </h5>
                        <div class="text-xs space-y-1" style="color: #7c2d12;">
                            <p><strong>Host:</strong> smtp-mail.outlook.com</p>
                            <p><strong>Port:</strong> 587 (STARTTLS)</p>
                            <p><strong>Username:</strong> your-email@outlook.com</p>
                            <p><strong>Password:</strong> Your account password</p>
                            <p><strong>Security:</strong> Enable STARTTLS</p>
                        </div>
                    </div>
                </div>

                <!-- Profile Status -->
                <div class="p-6 rounded-xl border-2" style="background: var(--bg-secondary); border-color: var(--border-color);">
                    <h4 class="text-lg font-semibold mb-4 flex items-center" style="color: var(--text-primary);">
                        <i class="fas fa-toggle-on mr-2" style="color: var(--purple-600-text);"></i>Profile Status
                    </h4>
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" name="active" id="profile-active" class="form-checkbox-enhanced" checked>
                        <span class="text-sm font-medium" style="color: var(--text-primary);">Active (Available for random selection)</span>
                    </label>
                    <p class="text-xs mt-2" style="color: var(--text-secondary);">Active profiles will be randomly selected for sending emails</p>
                </div>

                <!-- Form Actions -->
                <div class="flex items-center justify-end space-x-3 pt-6 border-t" style="border-color: var(--border-color);">
                    <button type="button" onclick="closeModal()" class="btn-secondary px-6 py-2 rounded-lg">
                        Cancel
                    </button>
                    <button type="submit" class="btn-primary-enhanced px-6 py-2 rounded-lg">
                        <i class="fas fa-save mr-2"></i>Save Profile
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Test SMTP Modal -->
<div id="test-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full">
            <!-- Modal Header -->
            <div class="p-6 border-b" style="border-color: var(--border-color);">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-lg flex items-center justify-center" style="background: var(--blue-600-bg);">
                            <i class="fas fa-paper-plane text-lg" style="color: var(--blue-600-text);"></i>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold" style="color: var(--text-primary);">Test SMTP Connection</h2>
                            <p class="text-sm" style="color: var(--text-secondary);">Send a test email to verify your configuration</p>
                        </div>
                    </div>
                    <button onclick="closeTestModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>

            <!-- Test Form -->
            <div class="p-6">
                <div class="space-y-4">
                    <div>
                        <label class="form-label" style="color: var(--text-primary); font-weight: 600;">Test Email Address</label>
                        <input type="email" id="test-email" class="form-input-enhanced" placeholder="test@example.com">
                    </div>
                    
                    <button onclick="sendTestEmail()" class="w-full btn-primary-enhanced py-3 rounded-lg">
                        <i class="fas fa-paper-plane mr-2"></i>Send Test Email
                    </button>
                </div>

                <!-- Test Results -->
                <div id="test-results" class="mt-6 hidden">
                    <div class="p-4 rounded-lg" style="background: var(--bg-secondary);">
                        <h4 class="font-semibold mb-2" style="color: var(--text-primary);">Test Results</h4>
                        <div id="test-message"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Diagnostics Modal -->
<div id="diagnostics-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <!-- Modal Header -->
            <div class="p-6 border-b" style="border-color: var(--border-color);">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-lg flex items-center justify-center" style="background: var(--yellow-600-bg);">
                            <i class="fas fa-stethoscope text-lg" style="color: var(--yellow-600-text);"></i>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold" style="color: var(--text-primary);">SMTP Diagnostics</h2>
                            <p class="text-sm" style="color: var(--text-secondary);">Comprehensive connection and delivery analysis</p>
                        </div>
                    </div>
                    <button onclick="closeDiagnosticsModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>

            <!-- Diagnostics Content -->
            <div class="p-6">
                <div id="diagnostics-content">
                    <!-- Content will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentProfileId = null;
let isEditMode = false;

function openAddModal() {
    isEditMode = false;
    document.getElementById('modal-title').textContent = 'Add New SMTP Profile';
    document.getElementById('smtp-form').action = '/smtp';
    document.getElementById('smtp-form').reset();
    document.getElementById('profile-id').value = '';
    document.getElementById('smtp-modal').style.display = 'block';
}

function editSMTP(profileId) {
    isEditMode = true;
    currentProfileId = profileId;
    
    // Get profile data from the DOM (you might want to fetch this via API)
    const profileCard = document.querySelector(`[onclick="editSMTP(${profileId})"]`).closest('.bg-white');
    const profileName = profileCard.querySelector('h3').textContent;
    const profileHost = profileCard.querySelector('p').textContent.split(':')[0];
    const profilePort = profileCard.querySelector('p').textContent.split(':')[1];
    
    document.getElementById('modal-title').textContent = 'Edit SMTP Profile';
    document.getElementById('smtp-form').action = `/smtp/${profileId}/edit`;
    document.getElementById('profile-name').value = profileName;
    document.getElementById('profile-host').value = profileHost;
    document.getElementById('profile-port').value = profilePort;
    
    // You'll need to populate other fields via API call
    document.getElementById('smtp-modal').style.display = 'block';
}

function closeModal() {
    document.getElementById('smtp-modal').style.display = 'none';
    currentProfileId = null;
    isEditMode = false;
}

function openTestModal() {
    document.getElementById('test-results').classList.add('hidden');
    document.getElementById('test-email').value = '';
    document.getElementById('test-modal').style.display = 'block';
}

function closeTestModal() {
    document.getElementById('test-modal').style.display = 'none';
}

function sendTestEmail() {
    const testEmail = document.getElementById('test-email').value;
    if (!testEmail) {
        showToast('Please enter a test email address', 'error');
        return;
    }
    
    fetch('/api/smtp/test', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            profile_id: currentProfileId,
            test_email: testEmail
        })
    })
    .then(response => response.json())
    .then(data => {
        const resultsDiv = document.getElementById('test-results');
        const messageDiv = document.getElementById('test-message');
        
        if (data.success) {
            messageDiv.innerHTML = `
                <div class="text-green-600 mb-2">
                    <i class="fas fa-check-circle mr-2"></i>${data.message}
                </div>
                <div class="text-sm text-gray-600">
                    <strong>Message ID:</strong> ${data.message_id}<br>
                    <strong>Delivery Optimization:</strong> ${data.delivery_optimization}
                </div>
            `;
        } else {
            messageDiv.innerHTML = `
                <div class="text-red-600 mb-2">
                    <i class="fas fa-exclamation-circle mr-2"></i>${data.error}
                </div>
                <div class="text-sm text-gray-600">
                    ${data.details ? data.details.join('<br>') : ''}
                </div>
            `;
        }
        
        resultsDiv.classList.remove('hidden');
    })
    .catch(error => {
        showToast('Error testing SMTP: ' + error.message, 'error');
    });
}

function runDiagnostics(profileId) {
    currentProfileId = profileId;
    
    fetch('/api/smtp/diagnostics', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            profile_id: profileId
        })
    })
    .then(response => response.json())
    .then(data => {
        displayDiagnosticsResults(data);
    })
    .catch(error => {
        showToast('Error running diagnostics: ' + error.message, 'error');
    });
}

function displayDiagnosticsResults(data) {
    const content = document.getElementById('diagnostics-content');
    
    content.innerHTML = `
        <div class="space-y-6">
            <!-- Connection Status -->
            <div class="p-4 rounded-lg" style="background: var(--bg-secondary);">
                <h4 class="font-semibold mb-3" style="color: var(--text-primary);">Connection Status</h4>
                <div class="grid grid-cols-2 gap-4">
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-${data.connection_success ? 'check-circle text-green-600' : 'times-circle text-red-600'}"></i>
                        <span style="color: var(--text-primary);">Connection: ${data.connection_success ? 'Success' : 'Failed'}</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-${data.authentication_success ? 'check-circle text-green-600' : 'times-circle text-red-600'}"></i>
                        <span style="color: var(--text-primary);">Authentication: ${data.authentication_success ? 'Success' : 'Failed'}</span>
                    </div>
                </div>
            </div>
            
            <!-- Inbox Delivery Score -->
            <div class="p-4 rounded-lg" style="background: var(--bg-secondary);">
                <h4 class="font-semibold mb-3" style="color: var(--text-primary);">Inbox Delivery Score</h4>
                <div class="text-center">
                    <div class="text-3xl font-bold mb-2" style="color: var(--text-primary);">${data.inbox_delivery_score}%</div>
                    <div class="text-lg font-medium" style="color: var(--text-secondary);">${data.inbox_delivery_rating}</div>
                </div>
            </div>
            
            <!-- Recommendations -->
            <div class="p-4 rounded-lg" style="background: var(--bg-secondary);">
                <h4 class="font-semibold mb-3" style="color: var(--text-primary);">Recommendations</h4>
                <ul class="space-y-2">
                    ${data.recommendations ? data.recommendations.map(rec => `<li class="text-sm" style="color: var(--text-secondary);">• ${rec}</li>`).join('') : '<li class="text-sm" style="color: var(--text-secondary);">No specific recommendations</li>'}
                </ul>
            </div>
        </div>
    `;
    
    document.getElementById('diagnostics-modal').style.display = 'block';
}

function closeDiagnosticsModal() {
    document.getElementById('diagnostics-modal').style.display = 'none';
    currentProfileId = null;
}

function toggleActive(profileId, currentStatus) {
    const action = currentStatus ? 'deactivate' : 'activate';
    if (!confirm(`Are you sure you want to ${action} this SMTP profile?`)) {
        return;
    }
    
    fetch(`/api/smtp/${profileId}/toggle-active`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('Error: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showToast('Error toggling status: ' + error.message, 'error');
    });
}

function deleteSMTP(profileId) {
    if (!confirm('Are you sure you want to delete this SMTP profile? This action cannot be undone.')) {
        return;
    }
    
    fetch(`/api/smtp/${profileId}/delete`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        if (response.ok) {
            showToast('SMTP profile deleted successfully', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('Error deleting SMTP profile', 'error');
        }
    })
    .catch(error => {
        showToast('Error deleting SMTP profile: ' + error.message, 'error');
    });
}

function testSMTP(profileId) {
    currentProfileId = profileId;
    openTestModal();
}

function showConfigurationGuide(host) {
    const sendgridGuide = document.getElementById('sendgrid-guide');
    const gmailGuide = document.getElementById('gmail-guide');
    const outlookGuide = document.getElementById('outlook-guide');

    // Hide all guides first
    sendgridGuide.classList.add('hidden');
    gmailGuide.classList.add('hidden');
    outlookGuide.classList.add('hidden');

    // Show relevant guide based on host
    if (host && host.toLowerCase().includes('sendgrid.net')) {
        sendgridGuide.classList.remove('hidden');
    } else if (host && host.toLowerCase().includes('gmail.com')) {
        gmailGuide.classList.remove('hidden');
    } else if (host && host.toLowerCase().includes('outlook.com')) {
        outlookGuide.classList.remove('hidden');
    }
}

// Close modals when clicking outside
window.onclick = function(event) {
    if (event.target.classList.contains('fixed')) {
        event.target.style.display = 'none';
    }
}
</script>
{% endblock %}
