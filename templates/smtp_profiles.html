{% extends "layout.html" %}

{% block title %}SMTP Profiles - Jasper TG BULK{% endblock %}

{% block content %}
<div class="min-h-screen" style="background: var(--bg-primary);">
    <!-- Header Section -->
    <div class="bg-white shadow-sm border-b" style="border-color: var(--border-color);">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-6">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 rounded-lg flex items-center justify-center" style="background: var(--blue-600-bg);">
                        <i class="fas fa-envelope text-xl" style="color: var(--blue-600-text);"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold" style="color: var(--text-primary);">SMTP Profiles</h1>
                        <p class="text-sm" style="color: var(--text-secondary);">Configure and manage your email server connections</p>
                    </div>
                </div>
                <button onclick="openAddModal()" class="btn-primary-enhanced px-6 py-3 rounded-lg flex items-center space-x-2">
                    <i class="fas fa-plus"></i>
                    <span>Add New Profile</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {% if rows %}
        <!-- SMTP Profiles Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for profile in rows %}
            <div class="bg-white rounded-xl shadow-sm border-2 transition-all duration-300 hover:shadow-lg" style="border-color: var(--border-color);">
                <!-- Profile Header -->
                <div class="p-6 border-b" style="border-color: var(--border-color);">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 rounded-lg flex items-center justify-center" style="background: var(--green-600-bg);">
                                <i class="fas fa-server text-lg" style="color: var(--green-600-text);"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold text-lg" style="color: var(--text-primary);">{{ profile.name }}</h3>
                                <p class="text-sm" style="color: var(--text-secondary);">{{ profile.host }}:{{ profile.port }}</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            {% if profile.active %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium" style="background: var(--status-active-bg); color: var(--status-active-text);">
                                <i class="fas fa-check-circle mr-1"></i>Active
                            </span>
                            {% else %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium" style="background: var(--status-inactive-bg); color: var(--status-inactive-text);">
                                <i class="fas fa-pause-circle mr-1"></i>Inactive
                            </span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Profile Details -->
                    <div class="space-y-2">
                        <div class="flex items-center space-x-2 text-sm">
                            <i class="fas fa-user" style="color: var(--text-secondary);"></i>
                            <span style="color: var(--text-primary);">{{ profile.username }}</span>
                        </div>
                        <div class="flex items-center space-x-2 text-sm">
                            <i class="fas fa-envelope" style="color: var(--text-secondary);"></i>
                            <span style="color: var(--text-primary);">{{ profile.from_email }}</span>
                        </div>
                        {% if profile.from_name %}
                        <div class="flex items-center space-x-2 text-sm">
                            <i class="fas fa-building" style="color: var(--text-secondary);"></i>
                            <span style="color: var(--text-primary);">{{ profile.from_name }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Security Info -->
                <div class="px-6 py-4 border-b" style="border-color: var(--border-color);">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            {% if profile.use_tls %}
                            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium" style="background: var(--green-100-bg); color: var(--green-600-text);">
                                <i class="fas fa-lock mr-1"></i>TLS
                            </span>
                            {% endif %}
                            {% if profile.use_starttls %}
                            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium" style="background: var(--blue-100-bg); color: var(--blue-600-text);">
                                <i class="fas fa-shield-alt mr-1"></i>STARTTLS
                            </span>
                            {% endif %}
                        </div>
                        <span class="text-xs" style="color: var(--text-secondary);">Created {{ profile.created_at.strftime('%b %d, %Y') }}</span>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="p-6">
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="testSMTP({{ profile.id }})" class="btn-success text-sm py-2 px-3 rounded-lg flex items-center justify-center space-x-2">
                            <i class="fas fa-paper-plane"></i>
                            <span>Test</span>
                        </button>
                        <button onclick="runDiagnostics({{ profile.id }})" class="btn-primary text-sm py-2 px-3 rounded-lg flex items-center justify-center space-x-2">
                            <i class="fas fa-stethoscope"></i>
                            <span>Diagnose</span>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3 mt-3">
                        <button onclick="toggleActive({{ profile.id }}, '{{ profile.active|lower }}')" class="btn-secondary text-sm py-2 px-3 rounded-lg flex items-center justify-center space-x-2">
                            <i class="fas fa-{% if profile.active %}pause{% else %}play{% endif %}"></i>
                            <span>{% if profile.active %}Deactivate{% else %}Activate{% endif %}</span>
                        </button>
                        <button onclick="editSMTP({{ profile.id }})" class="btn-warning text-sm py-2 px-3 rounded-lg flex items-center justify-center space-x-2">
                            <i class="fas fa-edit"></i>
                            <span>Edit</span>
                        </button>
                    </div>
                    
                    <button onclick="deleteSMTP({{ profile.id }})" class="w-full mt-3 btn-danger text-sm py-2 px-3 rounded-lg flex items-center justify-center space-x-2">
                        <i class="fas fa-trash"></i>
                        <span>Delete Profile</span>
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <!-- Empty State -->
        <div class="text-center py-16">
            <div class="w-24 h-24 mx-auto mb-6 rounded-full flex items-center justify-center" style="background: var(--gray-100-bg);">
                <i class="fas fa-envelope text-3xl" style="color: var(--text-secondary);"></i>
            </div>
            <h3 class="text-xl font-semibold mb-2" style="color: var(--text-primary);">No SMTP Profiles Yet</h3>
            <p class="text-sm mb-6" style="color: var(--text-secondary);">Get started by adding your first SMTP profile to send emails</p>
            <button onclick="openAddModal()" class="btn-primary-enhanced px-6 py-3 rounded-lg">
                <i class="fas fa-plus mr-2"></i>Add Your First Profile
            </button>
        </div>
        {% endif %}
    </div>
</div>

<!-- Add/Edit SMTP Profile Modal -->
<div id="smtp-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <!-- Modal Header -->
            <div class="p-6 border-b" style="border-color: var(--border-color);">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-lg flex items-center justify-center" style="background: var(--green-600-bg);">
                            <i class="fas fa-plus text-lg" style="color: var(--green-600-text);"></i>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold" style="color: var(--text-primary);" id="modal-title">Add New SMTP Profile</h2>
                            <p class="text-sm" style="color: var(--text-secondary);">Configure your email server connection</p>
                        </div>
                    </div>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>

            <!-- Modal Form -->
            <form id="smtp-form" method="POST" onsubmit="return submitSMTPForm()" class="p-6 space-y-6">
                <input type="hidden" id="profile-id" name="profile_id">
                
                <!-- Basic Information -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <label class="form-label" style="color: var(--text-primary); font-weight: 600;">
                            <i class="fas fa-tag mr-2" style="color: var(--blue-600-text);"></i>Profile Name
                        </label>
                        <input type="text" name="name" id="profile-name" required class="form-input-enhanced" placeholder="e.g., Gmail, Outlook, Company SMTP">
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="form-label" style="color: var(--text-primary); font-weight: 600;">SMTP Host</label>
                            <input type="text" name="host" id="profile-host" required class="form-input-enhanced" placeholder="e.g., smtp.elasticemail.com" onchange="showConfigurationGuide(this.value)">
                            <p class="text-xs mt-1" style="color: var(--text-secondary);">SMTP server address</p>
                        </div>
                        <div>
                            <label class="form-label" style="color: var(--text-primary); font-weight: 600;">Port</label>
                            <input type="number" name="port" id="profile-port" required class="form-input-enhanced" value="587" min="1" max="65535">
                            <p class="text-xs mt-1" style="color: var(--text-secondary);">587 (STARTTLS) or 465 (TLS)</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="form-label" style="color: var(--text-primary); font-weight: 600;">Username</label>
                            <input type="text" name="username" id="profile-username" required class="form-input-enhanced" placeholder="your-email@domain.com">
                            <p class="text-xs mt-1" style="color: var(--text-secondary);">Email address or API username</p>
                        </div>
                        <div>
                            <label class="form-label" style="color: var(--text-primary); font-weight: 600;">Password/API Key</label>
                            <input type="password" name="password" id="profile-password" class="form-input-enhanced" placeholder="App password or API key">
                            <p class="text-xs mt-1" style="color: var(--text-secondary);">Password or API key for authentication</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="form-label" style="color: var(--text-primary); font-weight: 600;">From Email</label>
                            <input type="email" name="from_email" id="profile-from-email" required class="form-input-enhanced" placeholder="noreply@yourcompany.com">
                            <p class="text-xs mt-1" style="color: var(--text-secondary);">Sender email address</p>
                        </div>
                        <div>
                            <label class="form-label" style="color: var(--text-primary); font-weight: 600;">From Name</label>
                            <input type="text" name="from_name" id="profile-from-name" class="form-input-enhanced" placeholder="Your Company Name">
                            <p class="text-xs mt-1" style="color: var(--text-secondary);">Display name for sender (optional)</p>
                        </div>
                    </div>
                </div>

                <!-- Security Settings -->
                <div class="space-y-3">
                    <label class="form-label" style="color: var(--text-primary); font-weight: 600;">Security Settings</label>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="flex items-center space-x-3">
                            <input type="checkbox" name="use_tls" id="profile-use-tls" class="form-checkbox-enhanced">
                            <label for="profile-use-tls" class="text-sm" style="color: var(--text-primary);">Use TLS (port 465)</label>
                        </div>
                        <div class="flex items-center space-x-3">
                            <input type="checkbox" name="use_starttls" id="profile-use-starttls" class="form-checkbox-enhanced" checked>
                            <label for="profile-use-starttls" class="text-sm" style="color: var(--text-primary);">Use STARTTLS (port 587)</label>
                        </div>
                    </div>
                    <p class="text-xs" style="color: var(--text-secondary);">üí° For ElasticEmail: Use port 587 with STARTTLS (recommended) or port 465 with TLS</p>
                </div>

                <!-- Configuration Guides -->
                <div class="space-y-4 mt-6">
                    <!-- ElasticEmail Guide -->
                    <div id="elasticemail-guide" class="hidden p-4 rounded-lg border-2" style="background: var(--bg-secondary); border-color: var(--blue-200);">
                        <div class="flex items-center space-x-3 mb-3">
                            <div class="w-8 h-8 rounded-lg flex items-center justify-center" style="background: var(--blue-600-bg);">
                                <i class="fas fa-envelope text-white"></i>
                            </div>
                            <h4 class="font-semibold" style="color: var(--text-primary);">ElasticEmail Configuration</h4>
                        </div>
                        <div class="space-y-2 text-sm" style="color: var(--text-secondary);">
                            <p><strong>Host:</strong> smtp.elasticemail.com</p>
                            <p><strong>Port:</strong> 587 (STARTTLS) or 465 (TLS)</p>
                            <p><strong>Username:</strong> Your ElasticEmail login email</p>
                            <p><strong>Password:</strong> Your ElasticEmail API key</p>
                            <p><strong>Security:</strong> Enable STARTTLS for port 587, or TLS for port 465</p>
                        </div>
                        <div class="mt-3 p-3 rounded" style="background: var(--blue-50);">
                            <p class="text-xs font-medium" style="color: var(--blue-700);">
                                üí° <strong>Pro Tip:</strong> Port 587 with STARTTLS is recommended for better compatibility and security.
                            </p>
                        </div>
                    </div>

                    <!-- Gmail Guide -->
                    <div id="gmail-guide" class="hidden p-4 rounded-lg border-2" style="background: var(--bg-secondary); border-color: var(--green-200);">
                        <div class="flex items-center space-x-3 mb-3">
                            <div class="w-8 h-8 rounded-lg flex items-center justify-center" style="background: var(--green-600-bg);">
                                <i class="fas fa-envelope text-white"></i>
                            </div>
                            <h4 class="font-semibold" style="color: var(--text-primary);">Gmail Configuration</h4>
                        </div>
                        <div class="space-y-2 text-sm" style="color: var(--text-secondary);">
                            <p><strong>Host:</strong> smtp.gmail.com</p>
                            <p><strong>Port:</strong> 587 (STARTTLS)</p>
                            <p><strong>Username:</strong> Your Gmail address</p>
                            <p><strong>Password:</strong> App password (not regular password)</p>
                            <p><strong>Security:</strong> Enable STARTTLS</p>
                        </div>
                        <div class="mt-3 p-3 rounded" style="background: var(--green-50);">
                            <p class="text-xs font-medium" style="color: var(--green-700);">
                                üîê <strong>Security:</strong> You need to generate an App Password in your Google Account settings.
                            </p>
                        </div>
                    </div>

                    <!-- Outlook Guide -->
                    <div id="outlook-guide" class="hidden p-4 rounded-lg border-2" style="background: var(--bg-secondary); border-color: var(--blue-200);">
                        <div class="flex items-center space-x-3 mb-3">
                            <div class="w-8 h-8 rounded-lg flex items-center justify-center" style="background: var(--blue-600-bg);">
                                <i class="fas fa-envelope text-white"></i>
                            </div>
                            <h4 class="font-semibold" style="color: var(--text-primary);">Outlook Configuration</h4>
                        </div>
                        <div class="space-y-2 text-sm" style="color: var(--text-secondary);">
                            <p><strong>Host:</strong> smtp-mail.outlook.com</p>
                            <p><strong>Port:</strong> 587 (STARTTLS)</p>
                            <p><strong>Username:</strong> Your Outlook email address</p>
                            <p><strong>Password:</strong> Your Outlook password</p>
                            <p><strong>Security:</strong> Enable STARTTLS</p>
                        </div>
                        <div class="mt-3 p-3 rounded" style="background: var(--blue-50);">
                            <p class="text-xs font-medium" style="color: var(--blue-700);">
                                ‚ö†Ô∏è <strong>Note:</strong> You may need to enable "Less secure app access" in your Outlook account.
                            </p>
                        </div>
                    </div>

                    <!-- SendGrid Guide -->
                    <div id="sendgrid-guide" class="hidden p-4 rounded-lg border-2" style="background: var(--bg-secondary); border-color: var(--orange-200);">
                        <div class="flex items-center space-x-3 mb-3">
                            <div class="w-8 h-8 rounded-lg flex items-center justify-center" style="background: var(--orange-600-bg);">
                                <i class="fas fa-envelope text-white"></i>
                            </div>
                            <h4 class="font-semibold" style="color: var(--text-primary);">SendGrid Configuration</h4>
                        </div>
                        <div class="space-y-2 text-sm" style="color: var(--text-secondary);">
                            <p><strong>Host:</strong> smtp.sendgrid.net</p>
                            <p><strong>Port:</strong> 587 (STARTTLS) or 465 (TLS)</p>
                            <p><strong>Username:</strong> apikey</p>
                            <p><strong>Password:</strong> Your SendGrid API key</p>
                            <p><strong>Security:</strong> Enable STARTTLS for port 587, or TLS for port 465</p>
                        </div>
                        <div class="mt-3 p-3 rounded" style="background: var(--orange-50);">
                            <p class="text-xs font-medium" style="color: var(--orange-700);">
                                üîë <strong>Username:</strong> Always use "apikey" as the username with SendGrid.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Profile Status -->
                <div class="p-6 rounded-xl border-2" style="background: var(--bg-secondary); border-color: var(--border-color);">
                    <h4 class="text-lg font-semibold mb-4 flex items-center" style="color: var(--text-primary);">
                        <i class="fas fa-toggle-on mr-2" style="color: var(--purple-600-text);"></i>Profile Status
                    </h4>
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" name="active" id="profile-active" class="form-checkbox-enhanced" checked>
                        <span class="text-sm font-medium" style="color: var(--text-primary);">Active (Available for random selection)</span>
                    </label>
                    <p class="text-xs mt-2" style="color: var(--text-secondary);">Active profiles will be randomly selected for sending emails</p>
                </div>

                <!-- Form Actions -->
                <div class="flex items-center justify-end space-x-3 pt-6 border-t" style="border-color: var(--border-color);">
                    <button type="button" onclick="closeModal()" class="btn-secondary px-6 py-2 rounded-lg">
                        Cancel
                    </button>
                    <button type="submit" class="btn-primary-enhanced px-6 py-2 rounded-lg">
                        <i class="fas fa-save mr-2"></i>Save Profile
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Test SMTP Modal -->
<div id="test-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full">
            <!-- Modal Header -->
            <div class="p-6 border-b" style="border-color: var(--border-color);">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-lg flex items-center justify-center" style="background: var(--blue-600-bg);">
                            <i class="fas fa-paper-plane text-lg" style="color: var(--blue-600-text);"></i>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold" style="color: var(--text-primary);">Test SMTP Connection</h2>
                            <p class="text-sm" style="color: var(--text-secondary);">Send a test email to verify your configuration</p>
                        </div>
                    </div>
                    <button onclick="closeTestModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>

            <!-- Test Form -->
            <div class="p-6">
                <div class="space-y-4">
                    <div>
                        <label class="form-label" style="color: var(--text-primary); font-weight: 600;">Test Email Address</label>
                        <input type="email" id="test-email" class="form-input-enhanced" placeholder="test@example.com">
                    </div>
                    
                    <button onclick="sendTestEmail()" class="w-full btn-primary-enhanced py-3 rounded-lg">
                        <i class="fas fa-paper-plane mr-2"></i>Send Test Email
                    </button>
                </div>

                <!-- Test Results -->
                <div id="test-results" class="mt-6 hidden">
                    <div class="p-4 rounded-lg" style="background: var(--bg-secondary);">
                        <h4 class="font-semibold mb-2" style="color: var(--text-primary);">Test Results</h4>
                        <div id="test-message"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Diagnostics Modal -->
<div id="diagnostics-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <!-- Modal Header -->
            <div class="p-6 border-b" style="border-color: var(--border-color);">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-lg flex items-center justify-center" style="background: var(--yellow-600-bg);">
                            <i class="fas fa-stethoscope text-lg" style="color: var(--yellow-600-text);"></i>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold" style="color: var(--text-primary);">SMTP Diagnostics</h2>
                            <p class="text-sm" style="color: var(--text-secondary);">Comprehensive connection and delivery analysis</p>
                        </div>
                    </div>
                    <button onclick="closeDiagnosticsModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>

            <!-- Diagnostics Content -->
            <div class="p-6">
                <div id="diagnostics-content">
                    <!-- Content will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notifications -->
<div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

<script>
let currentProfileId = null;
let isEditMode = false;

function openAddModal() {
    isEditMode = false;
    document.getElementById('modal-title').textContent = 'Add New SMTP Profile';
    document.getElementById('smtp-form').action = '/smtp';
    document.getElementById('smtp-form').reset();
    document.getElementById('profile-id').value = '';
    document.getElementById('smtp-modal').style.display = 'block';
}

function editSMTP(profileId) {
    isEditMode = true;
    currentProfileId = profileId;
    
    // Fetch profile data via API for accurate editing
    fetch(`/api/smtp/${profileId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const profile = data.profile;
                
                document.getElementById('modal-title').textContent = 'Edit SMTP Profile';
                document.getElementById('smtp-form').action = `/smtp/${profileId}/edit`;
                document.getElementById('profile-id').value = profileId;
                document.getElementById('profile-name').value = profile.name;
                document.getElementById('profile-host').value = profile.host;
                document.getElementById('profile-port').value = profile.port;
                document.getElementById('profile-username').value = profile.username;
                document.getElementById('profile-from-email').value = profile.from_email;
                document.getElementById('profile-from-name').value = profile.from_name || '';
                document.getElementById('profile-use-tls').checked = profile.use_tls;
                document.getElementById('profile-use-starttls').checked = profile.use_starttls;
                document.getElementById('profile-active').checked = profile.active;
                
                // Show configuration guide for the host
                showConfigurationGuide(profile.host);
                
                // Clear password field for security
                document.getElementById('profile-password').value = '';
                
                document.getElementById('smtp-modal').style.display = 'block';
            } else {
                showToast('Error loading profile: ' + data.error, 'error');
            }
        })
        .catch(error => {
            showToast('Error loading profile: ' + error.message, 'error');
        });
}

function closeModal() {
    document.getElementById('smtp-modal').style.display = 'none';
    currentProfileId = null;
    isEditMode = false;
}

function openTestModal() {
    document.getElementById('test-results').classList.add('hidden');
    document.getElementById('test-email').value = '';
    document.getElementById('test-modal').style.display = 'block';
}

function closeTestModal() {
    document.getElementById('test-modal').style.display = 'none';
}

function sendTestEmail() {
    const testEmail = document.getElementById('test-email').value;
    if (!testEmail) {
        showToast('Please enter a test email address', 'error');
        return;
    }
    
    fetch('/api/smtp/test', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            profile_id: currentProfileId,
            test_email: testEmail
        })
    })
    .then(response => response.json())
    .then(data => {
        const resultsDiv = document.getElementById('test-results');
        const messageDiv = document.getElementById('test-message');
        
        if (data.success) {
            messageDiv.innerHTML = `
                <div class="text-green-600 mb-2">
                    <i class="fas fa-check-circle mr-2"></i>${data.message}
                </div>
                <div class="text-sm text-gray-600">
                    <strong>Message ID:</strong> ${data.message_id}<br>
                    <strong>Delivery Optimization:</strong> ${data.delivery_optimization}
                </div>
            `;
        } else {
            messageDiv.innerHTML = `
                <div class="text-red-600 mb-2">
                    <i class="fas fa-exclamation-circle mr-2"></i>${data.error}
                </div>
                <div class="text-sm text-gray-600">
                    ${data.details ? data.details.join('<br>') : ''}
                </div>
            `;
        }
        
        resultsDiv.classList.remove('hidden');
    })
    .catch(error => {
        showToast('Error testing SMTP: ' + error.message, 'error');
    });
}

function runDiagnostics(profileId) {
    currentProfileId = profileId;
    
    fetch('/api/smtp/diagnostics', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            profile_id: profileId
        })
    })
    .then(response => response.json())
    .then(data => {
        displayDiagnosticsResults(data);
    })
    .catch(error => {
        showToast('Error running diagnostics: ' + error.message, 'error');
    });
}

function displayDiagnosticsResults(data) {
    const content = document.getElementById('diagnostics-content');
    
    content.innerHTML = `
        <div class="space-y-6">
            <!-- Connection Status -->
            <div class="p-4 rounded-lg" style="background: var(--bg-secondary);">
                <h4 class="font-semibold mb-3" style="color: var(--text-primary);">Connection Status</h4>
                <div class="grid grid-cols-2 gap-4">
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-${data.connection_success ? 'check-circle text-green-600' : 'times-circle text-red-600'}"></i>
                        <span style="color: var(--text-primary);">Connection: ${data.connection_success ? 'Success' : 'Failed'}</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-${data.authentication_success ? 'check-circle text-green-600' : 'times-circle text-red-600'}"></i>
                        <span style="color: var(--text-primary);">Authentication: ${data.authentication_success ? 'Success' : 'Failed'}</span>
                    </div>
                </div>
            </div>
            
            <!-- Inbox Delivery Score -->
            <div class="p-4 rounded-lg" style="background: var(--bg-secondary);">
                <h4 class="font-semibold mb-3" style="color: var(--text-primary);">Inbox Delivery Score</h4>
                <div class="text-center">
                    <div class="text-3xl font-bold mb-2" style="color: var(--text-primary);">${data.inbox_delivery_score}%</div>
                    <div class="text-lg font-medium" style="color: var(--text-secondary);">${data.inbox_delivery_rating}</div>
                </div>
            </div>
            
            <!-- Recommendations -->
            <div class="p-4 rounded-lg" style="background: var(--bg-secondary);">
                <h4 class="font-semibold mb-3" style="color: var(--text-primary);">Recommendations</h4>
                <ul class="space-y-2">
                    ${data.recommendations ? data.recommendations.map(rec => `<li class="text-sm" style="color: var(--text-secondary);">‚Ä¢ ${rec}</li>`).join('') : '<li class="text-sm" style="color: var(--text-secondary);">No specific recommendations</li>'}
                </ul>
            </div>
        </div>
    `;
    
    document.getElementById('diagnostics-modal').style.display = 'block';
}

function closeDiagnosticsModal() {
    document.getElementById('diagnostics-modal').style.display = 'none';
    currentProfileId = null;
}

function toggleActive(profileId, currentStatus) {
    const action = currentStatus ? 'deactivate' : 'activate';
    if (!confirm(`Are you sure you want to ${action} this SMTP profile?`)) {
        return;
    }
    
    fetch(`/api/smtp/${profileId}/toggle-active`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('Error: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showToast('Error toggling status: ' + error.message, 'error');
    });
}

function deleteSMTP(profileId) {
    if (!confirm('Are you sure you want to delete this SMTP profile? This action cannot be undone.')) {
        return;
    }
    
    fetch(`/api/smtp/${profileId}/delete`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        if (response.ok) {
            showToast('SMTP profile deleted successfully', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('Error deleting SMTP profile', 'error');
        }
    })
    .catch(error => {
        showToast('Error deleting SMTP profile: ' + error.message, 'error');
    });
}

function testSMTP(profileId) {
    currentProfileId = profileId;
    openTestModal();
}

function showConfigurationGuide(host) {
    const elasticemailGuide = document.getElementById('elasticemail-guide');
    const gmailGuide = document.getElementById('gmail-guide');
    const outlookGuide = document.getElementById('outlook-guide');
    const sendgridGuide = document.getElementById('sendgrid-guide');

    // Hide all guides first
    elasticemailGuide.classList.add('hidden');
    gmailGuide.classList.add('hidden');
    outlookGuide.classList.add('hidden');
    sendgridGuide.classList.add('hidden');

    // Show relevant guide based on host
    if (host && host.toLowerCase().includes('elasticemail.com')) {
        elasticemailGuide.classList.remove('hidden');
        // Auto-configure for ElasticEmail
        autoConfigureElasticEmail();
    } else if (host && host.toLowerCase().includes('gmail.com')) {
        gmailGuide.classList.remove('hidden');
        // Auto-configure for Gmail
        autoConfigureGmail();
    } else if (host && host.toLowerCase().includes('outlook.com')) {
        outlookGuide.classList.remove('hidden');
        // Auto-configure for Outlook
        autoConfigureOutlook();
    } else if (host && host.toLowerCase().includes('sendgrid.net')) {
        sendgridGuide.classList.remove('hidden');
        // Auto-configure for SendGrid
        autoConfigureSendGrid();
    }
}

function autoConfigureElasticEmail() {
    // Set recommended settings for ElasticEmail
    document.getElementById('profile-port').value = '587';
    document.getElementById('profile-use-tls').checked = false;
    document.getElementById('profile-use-starttls').checked = true;
    
    // Show helpful message
    showToast('Auto-configured for ElasticEmail: Port 587 with STARTTLS (recommended)', 'info');
}

function autoConfigureGmail() {
    // Set recommended settings for Gmail
    document.getElementById('profile-port').value = '587';
    document.getElementById('profile-use-tls').checked = false;
    document.getElementById('profile-use-starttls').checked = true;
    
    // Show helpful message
    showToast('Auto-configured for Gmail: Port 587 with STARTTLS', 'info');
}

function autoConfigureOutlook() {
    // Set recommended settings for Outlook
    document.getElementById('profile-port').value = '587';
    document.getElementById('profile-use-tls').checked = false;
    document.getElementById('profile-use-starttls').checked = true;
    
    // Show helpful message
    showToast('Auto-configured for Outlook: Port 587 with STARTTLS', 'info');
}

function autoConfigureSendGrid() {
    // Set recommended settings for SendGrid
    document.getElementById('profile-port').value = '587';
    document.getElementById('profile-use-tls').checked = false;
    document.getElementById('profile-use-starttls').checked = true;
    
    // Show helpful message
    showToast('Auto-configured for SendGrid: Port 587 with STARTTLS', 'info');
}

function validateSMTPForm() {
    const host = document.getElementById('profile-host').value.trim();
    const port = parseInt(document.getElementById('profile-port').value);
    const username = document.getElementById('profile-username').value.trim();
    const password = document.getElementById('profile-password').value;
    const fromEmail = document.getElementById('profile-from-email').value.trim();
    const useTls = document.getElementById('profile-use-tls').checked;
    const useStarttls = document.getElementById('profile-use-starttls').checked;
    
    // Basic validation
    if (!host) {
        showToast('SMTP host is required', 'error');
        return false;
    }
    
    if (!username) {
        showToast('Username is required', 'error');
        return false;
    }
    
    if (!isEditMode && !password) {
        showToast('Password/API key is required for new profiles', 'error');
        return false;
    }
    
    if (!fromEmail) {
        showToast('From email is required', 'error');
        return false;
    }
    
    // Port validation
    if (port < 1 || port > 65535) {
        showToast('Port must be between 1 and 65535', 'error');
        return false;
    }
    
    // Security validation
    if (port === 465 && !useTls) {
        showToast('Port 465 requires TLS to be enabled', 'error');
        return false;
    }
    
    if (port === 587 && !useStarttls) {
        showToast('Port 587 requires STARTTLS to be enabled', 'error');
        return false;
    }
    
    // ElasticEmail specific validation
    if (host.toLowerCase().includes('elasticemail.com')) {
        if (port !== 587 && port !== 465) {
            showToast('ElasticEmail supports ports 587 (STARTTLS) or 465 (TLS)', 'error');
            return false;
        }
        
        if (port === 587 && !useStarttls) {
            showToast('Port 587 with ElasticEmail requires STARTTLS', 'error');
            return false;
        }
        
        if (port === 465 && !useTls) {
            showToast('Port 465 with ElasticEmail requires TLS', 'error');
            return false;
        }
    }
    
    return true;
}

function submitSMTPForm() {
    if (!validateSMTPForm()) {
        return false;
    }
    
    // Show loading state
    const submitBtn = document.querySelector('#smtp-form button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
    submitBtn.disabled = true;
    
    // Submit form
    document.getElementById('smtp-form').submit();
    
    // Reset button after a delay
    setTimeout(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }, 3000);
    
    return true;
}

// Close modals when clicking outside
window.onclick = function(event) {
    if (event.target.classList.contains('fixed')) {
        event.target.style.display = 'none';
    }
}

function showToast(message, type = 'info') {
    const toastContainer = document.getElementById('toast-container');
    
    const toast = document.createElement('div');
    toast.className = `p-4 rounded-lg shadow-lg max-w-sm transform transition-all duration-300 translate-x-full`;
    
    let bgColor, textColor, icon;
    
    switch (type) {
        case 'success':
            bgColor = 'bg-green-500';
            textColor = 'text-white';
            icon = 'fas fa-check-circle';
            break;
        case 'error':
            bgColor = 'bg-red-500';
            textColor = 'text-white';
            icon = 'fas fa-exclamation-circle';
            break;
        case 'warning':
            bgColor = 'bg-yellow-500';
            textColor = 'text-white';
            icon = 'fas fa-exclamation-triangle';
            break;
        case 'info':
        default:
            bgColor = 'bg-blue-500';
            textColor = 'text-white';
            icon = 'fas fa-info-circle';
            break;
    }
    
    toast.innerHTML = `
        <div class="flex items-center space-x-3 ${bgColor} ${textColor} p-3 rounded-lg">
            <i class="${icon}"></i>
            <span class="text-sm font-medium">${message}</span>
            <button onclick="this.parentElement.parentElement.remove()" class="ml-auto text-white hover:text-gray-200">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    
    toastContainer.appendChild(toast);
    
    // Animate in
    setTimeout(() => {
        toast.classList.remove('translate-x-full');
    }, 100);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (toast.parentElement) {
            toast.classList.add('translate-x-full');
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 300);
        }
    }, 5000);
}
</script>
{% endblock %}
