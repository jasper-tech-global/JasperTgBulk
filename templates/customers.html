{% extends "layout.html" %}
{% block page_title %}Customers{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="page-header flex items-center justify-between">
        <div>
            <h1 class="page-title">Customer Management</h1>
            <p class="page-description">Manage who can use your Telegram bot to send emails</p>
        </div>
        <button onclick="toggleForm()" 
                style="display: inline-flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; font-weight: 600; padding: 0.75rem 1.5rem; border-radius: 0.75rem; border: none; cursor: pointer; transition: all 0.3s; font-size: 0.875rem; box-shadow: 0 4px 14px 0 rgba(59, 130, 246, 0.39);"
                onmouseenter="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px 0 rgba(59, 130, 246, 0.5)'"
                onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 14px 0 rgba(59, 130, 246, 0.39)'">
            <i class="fas fa-user-plus mr-2"></i>Add Customer
        </button>
    </div>

    <!-- Add Customer Form -->
    <div id="customer-form" class="card" style="display: none;">
        <h3 class="text-lg font-semibold text-gray-900 mb-6">Add New Customer</h3>
        <form method="post" action="/customers" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">Telegram Chat ID</label>
                    <input type="number" name="chat_id" required 
                           style="width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 0.875rem; transition: all 0.2s; outline: none;"
                           onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)'"
                           onblur="this.style.borderColor='#d1d5db'; this.style.boxShadow='none'"
                           onmouseenter="this.style.borderColor='#9ca3af'"
                           onmouseleave="this.style.borderColor='#d1d5db'"
                           placeholder="e.g., 123456789">
                    <p style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem;">The unique chat ID from Telegram</p>
                </div>
                <div>
                    <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">Customer Label</label>
                    <input type="text" name="label" 
                           style="width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 0.875rem; transition: all 0.2s; outline: none;"
                           onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)'"
                           onblur="this.style.borderColor='#d1d5db'; this.style.boxShadow='none'"
                           onmouseenter="this.style.borderColor='#9ca3af'"
                           onmouseleave="this.style.borderColor='#d1d5db'"
                           placeholder="e.g., John Doe, Company ABC">
                    <p style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem;">Optional label to identify the customer</p>
                </div>
            </div>

            <div style="display: flex; gap: 0.75rem; padding-top: 1.5rem; border-top: 1px solid #e5e7eb;">
                <button type="submit" 
                        style="display: inline-flex; align-items: center; justify-content: center; background-color: #059669; color: white; font-weight: 500; padding: 0.5rem 1rem; border-radius: 0.5rem; border: none; cursor: pointer; transition: all 0.2s; font-size: 0.875rem;"
                        onmouseenter="this.style.backgroundColor='#047857'; this.style.transform='scale(1.05)'"
                        onmouseleave="this.style.backgroundColor='#059669'; this.style.transform='scale(1)'">
                    <i class="fas fa-save mr-2"></i>Add Customer
                </button>
                <button type="button" onclick="toggleForm()" 
                        style="display: inline-flex; align-items: center; justify-content: center; background-color: #4b5563; color: white; font-weight: 500; padding: 0.5rem 1rem; border-radius: 0.5rem; border: none; cursor: pointer; transition: all 0.2s; font-size: 0.875rem;"
                        onmouseenter="this.style.backgroundColor='#374151'; this.style.transform='scale(1.05)'"
                        onmouseleave="this.style.backgroundColor='#4b5563'; this.style.transform='scale(1)'">
                    <i class="fas fa-times mr-2"></i>Cancel
                </button>
            </div>
        </form>
    </div>

    <!-- Customers Table -->
    <div class="table-container">
        <table class="table">
            <thead>
                <tr>
                    <th>Customer</th>
                    <th>Chat ID</th>
                    <th>Added</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for customer in rows %}
                <tr>
                    <td>
                        <div class="flex items-center">
                            <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                                <i class="fas fa-user text-blue-600"></i>
                            </div>
                            <div>
                                <div class="font-medium text-gray-900">
                                    {% if customer.label %}
                                        {{ customer.label }}
                                    {% else %}
                                        Customer #{{ customer.id }}
                                    {% endif %}
                                </div>
                                <div class="text-sm text-gray-500">ID: {{ customer.id }}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="flex items-center space-x-2">
                            <code class="px-2 py-1 bg-gray-100 text-gray-800 rounded text-sm font-mono">{{ customer.chat_id }}</code>
                            <button onclick="copyToClipboard('{{ customer.chat_id }}')" class="text-gray-400 hover:text-gray-600" title="Copy Chat ID">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </td>
                    <td>
                        <div class="text-sm text-gray-900">
                            {% if customer.created_at %}
                                {{ customer.created_at.strftime('%Y-%m-%d') }}
                            {% else %}
                                Unknown
                            {% endif %}
                        </div>
                        <div class="text-xs text-gray-500">
                            {% if customer.created_at %}
                                {{ customer.created_at.strftime('%H:%M') }}
                            {% endif %}
                        </div>
                    </td>
                    <td>
                        <form method="post" action="/customers/{{ customer.id }}/delete" class="inline" onsubmit="return confirm('Are you sure you want to remove this customer? They will no longer be able to use the bot.')">
                            <button type="submit" class="btn-danger text-sm">
                                <i class="fas fa-user-minus mr-1"></i>Remove
                            </button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Empty State -->
    {% if not rows %}
    <div class="card text-center py-12">
        <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <i class="fas fa-users text-3xl text-gray-400"></i>
        </div>
        <h3 class="text-lg font-medium text-gray-900 mb-2">No customers yet</h3>
        <p class="text-gray-600 mb-4">Add your first customer to allow them to use the Telegram bot for sending emails.</p>
        <button onclick="toggleForm()" class="btn-primary">
            <i class="fas fa-user-plus mr-2"></i>Add First Customer
        </button>
    </div>
    {% endif %}

    <!-- How to Get Chat ID -->
    <div class="card bg-blue-50 border-blue-200">
        <div class="flex items-start space-x-3">
            <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0 mt-1">
                <i class="fas fa-info text-blue-600"></i>
            </div>
            <div>
                <h4 class="font-medium text-blue-900 mb-2">How to get a Telegram Chat ID</h4>
                <ol class="text-sm text-blue-800 space-y-1 list-decimal list-inside">
                    <li>Ask the user to send a message to your bot</li>
                    <li>Visit: <code class="bg-blue-100 px-1 rounded">https://api.telegram.org/bot<strong>YOUR_BOT_TOKEN</strong>/getUpdates</code></li>
                    <li>Look for the "chat" object and find the "id" field</li>
                    <li>Use that number as the Chat ID when adding the customer</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<script>
function toggleForm() {
    const form = document.getElementById('customer-form');
    if (form.style.display === 'none') {
        form.style.display = 'block';
        form.scrollIntoView({ behavior: 'smooth' });
    } else {
        form.style.display = 'none';
    }
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(function() {
        showToast('Chat ID copied to clipboard!', 'success');
    }, function(err) {
        showToast('Failed to copy to clipboard', 'error');
    });
}
</script>
{% endblock %}
